<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>spring初识2 | 格物才可致知</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言对于上一篇spring的学习讲解，我大致理清了bean从配置到解析到注册到beanFactory中的过程。 那这次我将会学习spring在获取Bean实例和依赖注入的过程中的流程。 正题一般我们将一个ClassPathXmlApplicationContext实例赋予一个ApplicationContext接口变量之后，如果想要从ApplicationContext里获取bean，会调用get">
<meta property="og:type" content="article">
<meta property="og:title" content="spring初识2">
<meta property="og:url" content="http://yoursite.com/2019/11/02/spring学习2/index.html">
<meta property="og:site_name" content="格物才可致知">
<meta property="og:description" content="前言对于上一篇spring的学习讲解，我大致理清了bean从配置到解析到注册到beanFactory中的过程。 那这次我将会学习spring在获取Bean实例和依赖注入的过程中的流程。 正题一般我们将一个ClassPathXmlApplicationContext实例赋予一个ApplicationContext接口变量之后，如果想要从ApplicationContext里获取bean，会调用get">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2019-11-04T07:15:12.252Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="spring初识2">
<meta name="twitter:description" content="前言对于上一篇spring的学习讲解，我大致理清了bean从配置到解析到注册到beanFactory中的过程。 那这次我将会学习spring在获取Bean实例和依赖注入的过程中的流程。 正题一般我们将一个ClassPathXmlApplicationContext实例赋予一个ApplicationContext接口变量之后，如果想要从ApplicationContext里获取bean，会调用get">
  
    <link rel="alternate" href="/atom.xml" title="格物才可致知" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <div id="feologo"></div>
        <a href="/" id="logo">格物才可致知</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
<!--         
          <a href="/categories/web技术" class="main-nav-link">web技术</a>
        
          <a href="/categories/哲学" class="main-nav-link">哲学</a>
        
          <a href="/categories/外语学习" class="main-nav-link">外语学习</a>
        
          <a href="/categories/持久层技术" class="main-nav-link">持久层技术</a>
        
          <a href="/categories/数据结构与算法" class="main-nav-link">数据结构与算法</a>
        
          <a href="/categories/编程基础" class="main-nav-link">编程基础</a>
        
          <a href="/categories/软件构造思想" class="main-nav-link">软件构造思想</a>
        
          <a href="/categories/面向对象设计" class="main-nav-link">面向对象设计</a>
         -->
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-spring学习2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/02/spring学习2/" class="article-date">
  <time datetime="2019-11-02T13:00:45.172Z" itemprop="datePublished">2019-11-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web技术/">web技术</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      spring初识2
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>对于上一篇spring的学习讲解，我大致理清了bean从配置到解析到注册到beanFactory中的过程。</p>
<p>那这次我将会学习spring在获取Bean实例和依赖注入的过程中的流程。</p>
<h3 id="正题"><a href="#正题" class="headerlink" title="正题"></a>正题</h3><p>一般我们将一个ClassPathXmlApplicationContext实例赋予一个ApplicationContext接口变量之后，如果想要从ApplicationContext里获取bean，会调用getBean方法，所以我们以这个方法为入口点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractApplicationContext类</span><br><span class="line">@Override</span><br><span class="line">public Object getBean(String name) throws BeansException &#123;</span><br><span class="line">	assertBeanFactoryActive();</span><br><span class="line">	return getBeanFactory().getBean(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是getBean方法的实现。当我们调用getBean并将beanName作为参数传递给getBean方法时，会调用getBeanFactory方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractRefreshableApplicationContext类</span><br><span class="line">@Override</span><br><span class="line">public final ConfigurableListableBeanFactory getBeanFactory() &#123;</span><br><span class="line">	synchronized (this.beanFactoryMonitor) &#123;</span><br><span class="line">		if (this.beanFactory == null) &#123;</span><br><span class="line">			throw new IllegalStateException(&quot;BeanFactory not initialized or already closed - &quot; +</span><br><span class="line">					&quot;call &apos;refresh&apos; before accessing beans via the ApplicationContext&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		return this.beanFactory;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此方法会返回一个已经保存在AbstractRefreshableApplicationContextd的类实例中的beanFactory，而这个事先保存好的beanFactory实例在我第一篇学习的refresh方法调用obtainFreshBeanFactory方法再调用refreshBeanFactory方法时实例化的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractRefreshableApplicationContext类</span><br><span class="line">@Override</span><br><span class="line">protected final void refreshBeanFactory() throws BeansException &#123;</span><br><span class="line">     ......</span><br><span class="line">     ......</span><br><span class="line"></span><br><span class="line">		synchronized (this.beanFactoryMonitor) &#123;</span><br><span class="line">			this.beanFactory = beanFactory;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">     ......</span><br><span class="line">     ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到正题。在调用getBean后调用getBeanFactory方法之后，对得到的beanFactory再调用getBean方法，并将beanName作为参数。</p>
<p>那这个getBean方法在哪里定义呢？因为返回的是BeanFactory接口变量，所以我只有去实现BeanFactory接口的具体类中找寻。</p>
<p>在BeanFactory-HierarchicalBeanFactory-ConfigurableBeanFactory-AbstractBeanFactory这个继承体系中，我找到了具体的getBean方法实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractBeanFactory类</span><br><span class="line">@Override</span><br><span class="line">public Object getBean(String name) throws BeansException &#123;</span><br><span class="line">	return doGetBean(name, null, null, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法将逻辑委托给了同一类下的方法doGetBean：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">protected &lt;T&gt; T doGetBean(final String name, @Nullable final Class&lt;T&gt; requiredType,</span><br><span class="line">		@Nullable final Object[] args, boolean typeCheckOnly) throws BeansException &#123;</span><br><span class="line"></span><br><span class="line">	final String beanName = transformedBeanName(name);</span><br><span class="line">	Object bean;</span><br><span class="line"></span><br><span class="line">	// Eagerly check singleton cache for manually registered singletons.</span><br><span class="line">	Object sharedInstance = getSingleton(beanName);</span><br><span class="line">	if (sharedInstance != null &amp;&amp; args == null) &#123;</span><br><span class="line">		if (logger.isTraceEnabled()) &#123;</span><br><span class="line">			if (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">				logger.trace(&quot;Returning eagerly cached instance of singleton bean &apos;&quot; + beanName +</span><br><span class="line">						&quot;&apos; that is not fully initialized yet - a consequence of a circular reference&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				logger.trace(&quot;Returning cached instance of singleton bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	else &#123;</span><br><span class="line">		// Fail if we&apos;re already creating this bean instance:</span><br><span class="line">		// We&apos;re assumably within a circular reference.</span><br><span class="line">		if (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">			throw new BeanCurrentlyInCreationException(beanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Check if bean definition exists in this factory.</span><br><span class="line">		BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">		if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">			// Not found -&gt; check parent.</span><br><span class="line">			String nameToLookup = originalBeanName(name);</span><br><span class="line">			if (parentBeanFactory instanceof AbstractBeanFactory) &#123;</span><br><span class="line">				return ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">						nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">			&#125;</span><br><span class="line">			else if (args != null) &#123;</span><br><span class="line">				// Delegation to parent with explicit args.</span><br><span class="line">				return (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">			&#125;</span><br><span class="line">			else if (requiredType != null) &#123;</span><br><span class="line">				// No args -&gt; delegate to standard getBean method.</span><br><span class="line">				return parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				return (T) parentBeanFactory.getBean(nameToLookup);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (!typeCheckOnly) &#123;</span><br><span class="line">			markBeanAsCreated(beanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		try &#123;</span><br><span class="line">			final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">			checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">			// Guarantee initialization of beans that the current bean depends on.</span><br><span class="line">			String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">			if (dependsOn != null) &#123;</span><br><span class="line">				for (String dep : dependsOn) &#123;</span><br><span class="line">					if (isDependent(beanName, dep)) &#123;</span><br><span class="line">						throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">								&quot;Circular depends-on relationship between &apos;&quot; + beanName + &quot;&apos; and &apos;&quot; + dep + &quot;&apos;&quot;);</span><br><span class="line">					&#125;</span><br><span class="line">					registerDependentBean(dep, beanName);</span><br><span class="line">					try &#123;</span><br><span class="line">						getBean(dep);</span><br><span class="line">					&#125;</span><br><span class="line">					catch (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">						throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">								&quot;&apos;&quot; + beanName + &quot;&apos; depends on missing bean &apos;&quot; + dep + &quot;&apos;&quot;, ex);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			// Create bean instance.</span><br><span class="line">			if (mbd.isSingleton()) &#123;</span><br><span class="line">				sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">					try &#123;</span><br><span class="line">						return createBean(beanName, mbd, args);</span><br><span class="line">					&#125;</span><br><span class="line">					catch (BeansException ex) &#123;</span><br><span class="line">						// Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="line">						// eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="line">						// Also remove any beans that received a temporary reference to the bean.</span><br><span class="line">						destroySingleton(beanName);</span><br><span class="line">						throw ex;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">				bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			else if (mbd.isPrototype()) &#123;</span><br><span class="line">				// It&apos;s a prototype -&gt; create a new instance.</span><br><span class="line">				Object prototypeInstance = null;</span><br><span class="line">				try &#123;</span><br><span class="line">					beforePrototypeCreation(beanName);</span><br><span class="line">					prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">				&#125;</span><br><span class="line">				finally &#123;</span><br><span class="line">					afterPrototypeCreation(beanName);</span><br><span class="line">				&#125;</span><br><span class="line">				bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			else &#123;</span><br><span class="line">				String scopeName = mbd.getScope();</span><br><span class="line">				final Scope scope = this.scopes.get(scopeName);</span><br><span class="line">				if (scope == null) &#123;</span><br><span class="line">					throw new IllegalStateException(&quot;No Scope registered for scope name &apos;&quot; + scopeName + &quot;&apos;&quot;);</span><br><span class="line">				&#125;</span><br><span class="line">				try &#123;</span><br><span class="line">					Object scopedInstance = scope.get(beanName, () -&gt; &#123;</span><br><span class="line">						beforePrototypeCreation(beanName);</span><br><span class="line">						try &#123;</span><br><span class="line">							return createBean(beanName, mbd, args);</span><br><span class="line">						&#125;</span><br><span class="line">						finally &#123;</span><br><span class="line">							afterPrototypeCreation(beanName);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;);</span><br><span class="line">					bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">				&#125;</span><br><span class="line">				catch (IllegalStateException ex) &#123;</span><br><span class="line">					throw new BeanCreationException(beanName,</span><br><span class="line">							&quot;Scope &apos;&quot; + scopeName + &quot;&apos; is not active for the current thread; consider &quot; +</span><br><span class="line">							&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;,</span><br><span class="line">							ex);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (BeansException ex) &#123;</span><br><span class="line">			cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">			throw ex;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Check if required type matches the type of the actual bean instance.</span><br><span class="line">	if (requiredType != null &amp;&amp; !requiredType.isInstance(bean)) &#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">			if (convertedBean == null) &#123;</span><br><span class="line">				throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">			&#125;</span><br><span class="line">			return convertedBean;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (TypeMismatchException ex) &#123;</span><br><span class="line">			if (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(&quot;Failed to convert bean &apos;&quot; + name + &quot;&apos; to required type &apos;&quot; +</span><br><span class="line">						ClassUtils.getQualifiedName(requiredType) + &quot;&apos;&quot;, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return (T) bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在以上方法中，我们发现会先调用getSingleton方法查看事先指定beanName的bean是否已经注册保存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> // DefaultSingleonBeanRegistry类</span><br><span class="line">@Override</span><br><span class="line">@Nullable</span><br><span class="line">public Object getSingleton(String beanName) &#123;</span><br><span class="line">	return getSingleton(beanName, true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Nullable</span><br><span class="line">protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123;</span><br><span class="line">	Object singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">	if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">		synchronized (this.singletonObjects) &#123;</span><br><span class="line">			singletonObject = this.earlySingletonObjects.get(beanName);</span><br><span class="line">			if (singletonObject == null &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">				ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);</span><br><span class="line">				if (singletonFactory != null) &#123;</span><br><span class="line">					singletonObject = singletonFactory.getObject();</span><br><span class="line">					this.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">					this.singletonFactories.remove(beanName);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大体的逻辑便是先提取singletonObjects字段保存的bean，如果查找不到再到earlySingletonObjects字段查找，最后不行便用singletonFactories字段对应的beanFactory生成一个bean返回。</p>
<p>回到正题，在doGetBean方法中，如果getSingleton方法能够返回bean，便直接调用getObjectForBeanInstance方法，否则需要现成生成一个bean。</p>
<p>在现成生成一个bean的代码逻辑中，有几个部分：</p>
<p>部分1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// Check if bean definition exists in this factory.</span><br><span class="line">BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">  // Not found -&gt; check parent.</span><br><span class="line">  String nameToLookup = originalBeanName(name);</span><br><span class="line">  if (parentBeanFactory instanceof AbstractBeanFactory) &#123;</span><br><span class="line">    return ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">        nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">  &#125;</span><br><span class="line">  else if (args != null) &#123;</span><br><span class="line">    // Delegation to parent with explicit args.</span><br><span class="line">    return (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">  &#125;</span><br><span class="line">  else if (requiredType != null) &#123;</span><br><span class="line">    // No args -&gt; delegate to standard getBean method.</span><br><span class="line">    return parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    return (T) parentBeanFactory.getBean(nameToLookup);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此部分主要是在利用containsBeanDefinition方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> // DefaultListableBeanFactory类</span><br><span class="line">@Override</span><br><span class="line">public boolean containsBeanDefinition(String beanName) &#123;</span><br><span class="line">	Assert.notNull(beanName, &quot;Bean name must not be null&quot;);</span><br><span class="line">	return this.beanDefinitionMap.containsKey(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断如果此bean在之前没有注册到DefaultListableBeanFactory类的字段beanDefinitionMap里的话，便到父beanFactory中查找。并调用getBean方法或者doGetBean方法获取bean。</p>
<p>部分2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">// Guarantee initialization of beans that the current bean depends on.</span><br><span class="line">String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">if (dependsOn != null) &#123;</span><br><span class="line">  for (String dep : dependsOn) &#123;</span><br><span class="line">    if (isDependent(beanName, dep)) &#123;</span><br><span class="line">      throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">          &quot;Circular depends-on relationship between &apos;&quot; + beanName + &quot;&apos; and &apos;&quot; + dep + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    registerDependentBean(dep, beanName);</span><br><span class="line">    try &#123;</span><br><span class="line">      getBean(dep);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">      throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">          &quot;&apos;&quot; + beanName + &quot;&apos; depends on missing bean &apos;&quot; + dep + &quot;&apos;&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此部分的主要目的是根据需要的bean的依赖，调用registerDependentBean对每一个依赖进行注册：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> // DefaultSingleonBeanRegistry类</span><br><span class="line">public void registerDependentBean(String beanName, String dependentBeanName) &#123;</span><br><span class="line">	String canonicalName = canonicalName(beanName);</span><br><span class="line"></span><br><span class="line">	synchronized (this.dependentBeanMap) &#123;</span><br><span class="line">		Set&lt;String&gt; dependentBeans =</span><br><span class="line">				this.dependentBeanMap.computeIfAbsent(canonicalName, k -&gt; new LinkedHashSet&lt;&gt;(8));</span><br><span class="line">		if (!dependentBeans.add(dependentBeanName)) &#123;</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	synchronized (this.dependenciesForBeanMap) &#123;</span><br><span class="line">		Set&lt;String&gt; dependenciesForBean =</span><br><span class="line">				this.dependenciesForBeanMap.computeIfAbsent(dependentBeanName, k -&gt; new LinkedHashSet&lt;&gt;(8));</span><br><span class="line">		dependenciesForBean.add(canonicalName);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并调用getBean方法处理每一个依赖bean。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">registerDependentBean(dep, beanName);</span><br><span class="line">try &#123;</span><br><span class="line">  getBean(dep);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>在部分2中，我们调用了getMergedLocalBeanDefinition方法获取了RootBeanDefinition类型变量mdb。在之后我会讲解此方法。</p>
<p>部分3：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">// Create bean instance.</span><br><span class="line">if (mbd.isSingleton()) &#123;</span><br><span class="line">  sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      return createBean(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (BeansException ex) &#123;</span><br><span class="line">      // Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="line">      // eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="line">      // Also remove any beans that received a temporary reference to the bean.</span><br><span class="line">      destroySingleton(beanName);</span><br><span class="line">      throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">else if (mbd.isPrototype()) &#123;</span><br><span class="line">  // It&apos;s a prototype -&gt; create a new instance.</span><br><span class="line">  Object prototypeInstance = null;</span><br><span class="line">  try &#123;</span><br><span class="line">    beforePrototypeCreation(beanName);</span><br><span class="line">    prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">  &#125;</span><br><span class="line">  finally &#123;</span><br><span class="line">    afterPrototypeCreation(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">  bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">else &#123;</span><br><span class="line">  String scopeName = mbd.getScope();</span><br><span class="line">  final Scope scope = this.scopes.get(scopeName);</span><br><span class="line">  if (scope == null) &#123;</span><br><span class="line">    throw new IllegalStateException(&quot;No Scope registered for scope name &apos;&quot; + scopeName + &quot;&apos;&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  try &#123;</span><br><span class="line">    Object scopedInstance = scope.get(beanName, () -&gt; &#123;</span><br><span class="line">      beforePrototypeCreation(beanName);</span><br><span class="line">      try &#123;</span><br><span class="line">        return createBean(beanName, mbd, args);</span><br><span class="line">      &#125;</span><br><span class="line">      finally &#123;</span><br><span class="line">        afterPrototypeCreation(beanName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">  &#125;</span><br><span class="line">  catch (IllegalStateException ex) &#123;</span><br><span class="line">    throw new BeanCreationException(beanName,</span><br><span class="line">        &quot;Scope &apos;&quot; + scopeName + &quot;&apos; is not active for the current thread; consider &quot; +</span><br><span class="line">        &quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;,</span><br><span class="line">        ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这部分中，判断mdb变量的生命周期后都会调用createBean方法，并将beanName，mdb，和args作为参数产生一个bean实例。并再调用getObjectForBeanInstance方法作为最后的bean实例返回。</p>
<p>部分4：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// Check if required type matches the type of the actual bean instance.</span><br><span class="line">if (requiredType != null &amp;&amp; !requiredType.isInstance(bean)) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">    if (convertedBean == null) &#123;</span><br><span class="line">      throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">    return convertedBean;</span><br><span class="line">  &#125;</span><br><span class="line">  catch (TypeMismatchException ex) &#123;</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">      logger.trace(&quot;Failed to convert bean &apos;&quot; + name + &quot;&apos; to required type &apos;&quot; +</span><br><span class="line">          ClassUtils.getQualifiedName(requiredType) + &quot;&apos;&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">return (T) bean;</span><br></pre></td></tr></table></figure>

<p>在这部分中的逻辑主要是对产生的bean进行类型转换，因为此方法调用时会有个requiredType变量作为参数，指定返回bean的类型，所以需要我们进行转换。</p>
<p>在讲解完这几个部分后，会知道有几个比较重要的函数：</p>
<ul>
<li>getObjectForBeanInstance</li>
<li>getMergedLocalBeanDefinition</li>
<li>createBean</li>
</ul>
<p>这几个函数在我这次讲解当中充当了比较重要的位置。</p>
<p>首先我的讲解顺序会是getMergedLocalBeanDefinition，然后是createBean，最后会是getObjectForBeanInstance。</p>
<h3 id="getMergedLocalBeanDefinition"><a href="#getMergedLocalBeanDefinition" class="headerlink" title="getMergedLocalBeanDefinition"></a>getMergedLocalBeanDefinition</h3><p>此方法的具体定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractBeanFactory类</span><br><span class="line">protected RootBeanDefinition getMergedLocalBeanDefinition(String beanName) throws BeansException &#123;</span><br><span class="line">	// Quick check on the concurrent map first, with minimal locking.</span><br><span class="line">	RootBeanDefinition mbd = this.mergedBeanDefinitions.get(beanName);</span><br><span class="line">	if (mbd != null &amp;&amp; !mbd.stale) &#123;</span><br><span class="line">		return mbd;</span><br><span class="line">	&#125;</span><br><span class="line">	return getMergedBeanDefinition(beanName, getBeanDefinition(beanName));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected RootBeanDefinition getMergedBeanDefinition(String beanName, BeanDefinition bd)</span><br><span class="line">		throws BeanDefinitionStoreException &#123;</span><br><span class="line"></span><br><span class="line">	return getMergedBeanDefinition(beanName, bd, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected RootBeanDefinition getMergedBeanDefinition(</span><br><span class="line">		String beanName, BeanDefinition bd, @Nullable BeanDefinition containingBd)</span><br><span class="line">		throws BeanDefinitionStoreException &#123;</span><br><span class="line"></span><br><span class="line">	synchronized (this.mergedBeanDefinitions) &#123;</span><br><span class="line">		RootBeanDefinition mbd = null;</span><br><span class="line">		RootBeanDefinition previous = null;</span><br><span class="line"></span><br><span class="line">		// Check with full lock now in order to enforce the same merged instance.</span><br><span class="line">		if (containingBd == null) &#123;</span><br><span class="line">			mbd = this.mergedBeanDefinitions.get(beanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (mbd == null || mbd.stale) &#123;</span><br><span class="line">			previous = mbd;</span><br><span class="line">			mbd = null;</span><br><span class="line">			if (bd.getParentName() == null) &#123;</span><br><span class="line">				// Use copy of given root bean definition.</span><br><span class="line">				if (bd instanceof RootBeanDefinition) &#123;</span><br><span class="line">					mbd = ((RootBeanDefinition) bd).cloneBeanDefinition();</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					mbd = new RootBeanDefinition(bd);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				// Child bean definition: needs to be merged with parent.</span><br><span class="line">				BeanDefinition pbd;</span><br><span class="line">				try &#123;</span><br><span class="line">					String parentBeanName = transformedBeanName(bd.getParentName());</span><br><span class="line">					if (!beanName.equals(parentBeanName)) &#123;</span><br><span class="line">						pbd = getMergedBeanDefinition(parentBeanName);</span><br><span class="line">					&#125;</span><br><span class="line">					else &#123;</span><br><span class="line">						BeanFactory parent = getParentBeanFactory();</span><br><span class="line">						if (parent instanceof ConfigurableBeanFactory) &#123;</span><br><span class="line">							pbd = ((ConfigurableBeanFactory) parent).getMergedBeanDefinition(parentBeanName);</span><br><span class="line">						&#125;</span><br><span class="line">						else &#123;</span><br><span class="line">							throw new NoSuchBeanDefinitionException(parentBeanName,</span><br><span class="line">									&quot;Parent name &apos;&quot; + parentBeanName + &quot;&apos; is equal to bean name &apos;&quot; + beanName +</span><br><span class="line">									&quot;&apos;: cannot be resolved without an AbstractBeanFactory parent&quot;);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				catch (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">					throw new BeanDefinitionStoreException(bd.getResourceDescription(), beanName,</span><br><span class="line">							&quot;Could not resolve parent bean definition &apos;&quot; + bd.getParentName() + &quot;&apos;&quot;, ex);</span><br><span class="line">				&#125;</span><br><span class="line">				// Deep copy with overridden values.</span><br><span class="line">				mbd = new RootBeanDefinition(pbd);</span><br><span class="line">				mbd.overrideFrom(bd);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			// Set default singleton scope, if not configured before.</span><br><span class="line">			if (!StringUtils.hasLength(mbd.getScope())) &#123;</span><br><span class="line">				mbd.setScope(RootBeanDefinition.SCOPE_SINGLETON);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			// A bean contained in a non-singleton bean cannot be a singleton itself.</span><br><span class="line">			// Let&apos;s correct this on the fly here, since this might be the result of</span><br><span class="line">			// parent-child merging for the outer bean, in which case the original inner bean</span><br><span class="line">			// definition will not have inherited the merged outer bean&apos;s singleton status.</span><br><span class="line">			if (containingBd != null &amp;&amp; !containingBd.isSingleton() &amp;&amp; mbd.isSingleton()) &#123;</span><br><span class="line">				mbd.setScope(containingBd.getScope());</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			// Cache the merged bean definition for the time being</span><br><span class="line">			// (it might still get re-merged later on in order to pick up metadata changes)</span><br><span class="line">			if (containingBd == null &amp;&amp; isCacheBeanMetadata()) &#123;</span><br><span class="line">				this.mergedBeanDefinitions.put(beanName, mbd);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		if (previous != null) &#123;</span><br><span class="line">			copyRelevantMergedBeanDefinitionCaches(previous, mbd);</span><br><span class="line">		&#125;</span><br><span class="line">		return mbd;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在此方法的只接受一个字符串参数的版本中，调用了一个getBeanDefinition方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> // DefaultListableBeanFactory类</span><br><span class="line">@Override</span><br><span class="line">public BeanDefinition getBeanDefinition(String beanName) throws NoSuchBeanDefinitionException &#123;</span><br><span class="line">	BeanDefinition bd = this.beanDefinitionMap.get(beanName);</span><br><span class="line">	if (bd == null) &#123;</span><br><span class="line">		if (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(&quot;No bean named &apos;&quot; + beanName + &quot;&apos; found in &quot; + this);</span><br><span class="line">		&#125;</span><br><span class="line">		throw new NoSuchBeanDefinitionException(beanName);</span><br><span class="line">	&#125;</span><br><span class="line">	return bd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上实现代码，可知bean是从之前注册bean到beanFactory的beanDefinitionMap字段时的beanDefinition类型的变量提取出来返回。</p>
<p>然后在最后一个版本的getMergedBeanDefinition中，会先从此方法对应的类DefaultListableBeanFactory的this.mergedBeanDefinitions映射变量字段中查找对应beanName的beanDefinition，如果找不到，则会执行下面的逻辑。主要分成两个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (bd.getParentName() == null) &#123;</span><br><span class="line">  // Use copy of given root bean definition.</span><br><span class="line">  if (bd instanceof RootBeanDefinition) &#123;</span><br><span class="line">    mbd = ((RootBeanDefinition) bd).cloneBeanDefinition();</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    mbd = new RootBeanDefinition(bd);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此上的逻辑主要是将参数传入的BeanDefinition类型的bd变量在没有父级beanDefinition时转换为RootBeanDefinition类型的变量mdb。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">else &#123;</span><br><span class="line">  // Child bean definition: needs to be merged with parent.</span><br><span class="line">  BeanDefinition pbd;</span><br><span class="line">  try &#123;</span><br><span class="line">    String parentBeanName = transformedBeanName(bd.getParentName());</span><br><span class="line">    if (!beanName.equals(parentBeanName)) &#123;</span><br><span class="line">      pbd = getMergedBeanDefinition(parentBeanName);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">      BeanFactory parent = getParentBeanFactory();</span><br><span class="line">      if (parent instanceof ConfigurableBeanFactory) &#123;</span><br><span class="line">        pbd = ((ConfigurableBeanFactory) parent).getMergedBeanDefinition(parentBeanName);</span><br><span class="line">      &#125;</span><br><span class="line">      else &#123;</span><br><span class="line">        throw new NoSuchBeanDefinitionException(parentBeanName,</span><br><span class="line">            &quot;Parent name &apos;&quot; + parentBeanName + &quot;&apos; is equal to bean name &apos;&quot; + beanName +</span><br><span class="line">            &quot;&apos;: cannot be resolved without an AbstractBeanFactory parent&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  catch (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">    throw new BeanDefinitionStoreException(bd.getResourceDescription(), beanName,</span><br><span class="line">        &quot;Could not resolve parent bean definition &apos;&quot; + bd.getParentName() + &quot;&apos;&quot;, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  // Deep copy with overridden values.</span><br><span class="line">  mbd = new RootBeanDefinition(pbd);</span><br><span class="line">  mbd.overrideFrom(bd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是对父级bean调用getMergedBeanDefinition方法，最后再转换为RootBeanDefinition类型的变量。</p>
<p>最后将mdb作为结果返回。于是得到了RootBeanDefinition类型的变量，便可以进行下一步操作。</p>
<h3 id="createBean"><a href="#createBean" class="headerlink" title="createBean"></a>createBean</h3><p>此方法的实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractAutowireCapableBeanFactory类</span><br><span class="line">@Override</span><br><span class="line">protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span><br><span class="line">		throws BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">	if (logger.isTraceEnabled()) &#123;</span><br><span class="line">		logger.trace(&quot;Creating instance of bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	RootBeanDefinition mbdToUse = mbd;</span><br><span class="line"></span><br><span class="line">	// Make sure bean class is actually resolved at this point, and</span><br><span class="line">	// clone the bean definition in case of a dynamically resolved Class</span><br><span class="line">	// which cannot be stored in the shared merged bean definition.</span><br><span class="line">	Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</span><br><span class="line">	if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null) &#123;</span><br><span class="line">		mbdToUse = new RootBeanDefinition(mbd);</span><br><span class="line">		mbdToUse.setBeanClass(resolvedClass);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Prepare method overrides.</span><br><span class="line">	try &#123;</span><br><span class="line">		mbdToUse.prepareMethodOverrides();</span><br><span class="line">	&#125;</span><br><span class="line">	catch (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">		throw new BeanDefinitionStoreException(mbdToUse.getResourceDescription(),</span><br><span class="line">				beanName, &quot;Validation of method overrides failed&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	try &#123;</span><br><span class="line">		// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span><br><span class="line">		Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">		if (bean != null) &#123;</span><br><span class="line">			return bean;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		throw new BeanCreationException(mbdToUse.getResourceDescription(), beanName,</span><br><span class="line">				&quot;BeanPostProcessor before instantiation of bean failed&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	try &#123;</span><br><span class="line">		Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">		if (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(&quot;Finished creating instance of bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		return beanInstance;</span><br><span class="line">	&#125;</span><br><span class="line">	catch (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;</span><br><span class="line">		// A previously detected exception with proper bean creation context already,</span><br><span class="line">		// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span><br><span class="line">		throw ex;</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		throw new BeanCreationException(</span><br><span class="line">				mbdToUse.getResourceDescription(), beanName, &quot;Unexpected exception during bean creation&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于这次主要讲的是Bean的实例生成，所以我会将关注点放在此上，也就是会将此方法的重点总结为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">  Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">  if (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(&quot;Finished creating instance of bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return beanInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码。也就是说，此方法会利用已有的beanName，RootBeanDefinition类型变量mbdToUse和构造参数来调用doCreateBean方法。最后生成bean实例返回。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractAutowireCapableBeanFactory类</span><br><span class="line">protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)</span><br><span class="line">		throws BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">	// Instantiate the bean.</span><br><span class="line">	BeanWrapper instanceWrapper = null;</span><br><span class="line">	if (mbd.isSingleton()) &#123;</span><br><span class="line">		instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">	&#125;</span><br><span class="line">	if (instanceWrapper == null) &#123;</span><br><span class="line">		instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">	&#125;</span><br><span class="line">	final Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">	Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">	if (beanType != NullBean.class) &#123;</span><br><span class="line">		mbd.resolvedTargetType = beanType;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Allow post-processors to modify the merged bean definition.</span><br><span class="line">	synchronized (mbd.postProcessingLock) &#123;</span><br><span class="line">		if (!mbd.postProcessed) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Throwable ex) &#123;</span><br><span class="line">				throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">						&quot;Post-processing of merged bean definition failed&quot;, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			mbd.postProcessed = true;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Eagerly cache singletons to be able to resolve circular references</span><br><span class="line">	// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br><span class="line">	boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp;</span><br><span class="line">			isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">	if (earlySingletonExposure) &#123;</span><br><span class="line">		if (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(&quot;Eagerly caching bean &apos;&quot; + beanName +</span><br><span class="line">					&quot;&apos; to allow for resolving potential circular references&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Initialize the bean instance.</span><br><span class="line">	Object exposedObject = bean;</span><br><span class="line">	try &#123;</span><br><span class="line">		populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">		exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">			throw (BeanCreationException) ex;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			throw new BeanCreationException(</span><br><span class="line">					mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (earlySingletonExposure) &#123;</span><br><span class="line">		Object earlySingletonReference = getSingleton(beanName, false);</span><br><span class="line">		if (earlySingletonReference != null) &#123;</span><br><span class="line">			if (exposedObject == bean) &#123;</span><br><span class="line">				exposedObject = earlySingletonReference;</span><br><span class="line">			&#125;</span><br><span class="line">			else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">				String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">				Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;&gt;(dependentBeans.length);</span><br><span class="line">				for (String dependentBean : dependentBeans) &#123;</span><br><span class="line">					if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">						actualDependentBeans.add(dependentBean);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				if (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">					throw new BeanCurrentlyInCreationException(beanName,</span><br><span class="line">							&quot;Bean with name &apos;&quot; + beanName + &quot;&apos; has been injected into other beans [&quot; +</span><br><span class="line">							StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">							&quot;] in its raw version as part of a circular reference, but has eventually been &quot; +</span><br><span class="line">							&quot;wrapped. This means that said other beans do not use the final version of the &quot; +</span><br><span class="line">							&quot;bean. This is often the result of over-eager type matching - consider using &quot; +</span><br><span class="line">							&quot;&apos;getBeanNamesOfType&apos; with the &apos;allowEagerInit&apos; flag turned off, for example.&quot;);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Register bean as disposable.</span><br><span class="line">	try &#123;</span><br><span class="line">		registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">		throw new BeanCreationException(</span><br><span class="line">				mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分方法实现我将讨论几部分：</p>
<h4 id="部分1"><a href="#部分1" class="headerlink" title="部分1"></a>部分1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// Instantiate the bean.</span><br><span class="line">BeanWrapper instanceWrapper = null;</span><br><span class="line">if (mbd.isSingleton()) &#123;</span><br><span class="line">  instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">&#125;</span><br><span class="line">if (instanceWrapper == null) &#123;</span><br><span class="line">  instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">&#125;</span><br><span class="line">final Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">if (beanType != NullBean.class) &#123;</span><br><span class="line">  mbd.resolvedTargetType = beanType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此部分主要是根据传进来的beanName，mbd，和args参数调用createBeanInstance方法，并生成BeanWapper类型的变量instanceWrapper。</p>
<h5 id="createBeanInstance"><a href="#createBeanInstance" class="headerlink" title="createBeanInstance"></a>createBeanInstance</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractAutowireCapableBeanFactory类</span><br><span class="line">protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) &#123;</span><br><span class="line">	// Make sure bean class is actually resolved at this point.</span><br><span class="line">	Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</span><br><span class="line"></span><br><span class="line">	if (beanClass != null &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;</span><br><span class="line">		throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">				&quot;Bean class isn&apos;t public, and non-public access not allowed: &quot; + beanClass.getName());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();</span><br><span class="line">	if (instanceSupplier != null) &#123;</span><br><span class="line">		return obtainFromSupplier(instanceSupplier, beanName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (mbd.getFactoryMethodName() != null) &#123;</span><br><span class="line">		return instantiateUsingFactoryMethod(beanName, mbd, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Shortcut when re-creating the same bean...</span><br><span class="line">	boolean resolved = false;</span><br><span class="line">	boolean autowireNecessary = false;</span><br><span class="line">	if (args == null) &#123;</span><br><span class="line">		synchronized (mbd.constructorArgumentLock) &#123;</span><br><span class="line">			if (mbd.resolvedConstructorOrFactoryMethod != null) &#123;</span><br><span class="line">				resolved = true;</span><br><span class="line">				autowireNecessary = mbd.constructorArgumentsResolved;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if (resolved) &#123;</span><br><span class="line">		if (autowireNecessary) &#123;</span><br><span class="line">			return autowireConstructor(beanName, mbd, null, null);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			return instantiateBean(beanName, mbd);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Candidate constructors for autowiring?</span><br><span class="line">	Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">	if (ctors != null || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">			mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;</span><br><span class="line">		return autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Preferred constructors for default construction?</span><br><span class="line">	ctors = mbd.getPreferredConstructors();</span><br><span class="line">	if (ctors != null) &#123;</span><br><span class="line">		return autowireConstructor(beanName, mbd, ctors, null);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// No special handling: simply use no-arg constructor.</span><br><span class="line">	return instantiateBean(beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是createBeanInstance实现代码。可见，返回return的BeanWrapper实例可用以四个方法生成：</p>
<ul>
<li>obtainFromSupplier</li>
<li>instantiateUsingFactoryMethod</li>
<li>autowireConstructor</li>
<li>instantiateBean</li>
</ul>
<p>我选取其中一个autowireConstructor作为我分析讲解的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"> // ConstructorResolver类</span><br><span class="line">public BeanWrapper autowireConstructor(String beanName, RootBeanDefinition mbd,</span><br><span class="line">		@Nullable Constructor&lt;?&gt;[] chosenCtors, @Nullable Object[] explicitArgs) &#123;</span><br><span class="line"></span><br><span class="line">	BeanWrapperImpl bw = new BeanWrapperImpl();</span><br><span class="line">	this.beanFactory.initBeanWrapper(bw);</span><br><span class="line"></span><br><span class="line">	Constructor&lt;?&gt; constructorToUse = null;</span><br><span class="line">	ArgumentsHolder argsHolderToUse = null;</span><br><span class="line">	Object[] argsToUse = null;</span><br><span class="line"></span><br><span class="line">	if (explicitArgs != null) &#123;</span><br><span class="line">		argsToUse = explicitArgs;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		Object[] argsToResolve = null;</span><br><span class="line">		synchronized (mbd.constructorArgumentLock) &#123;</span><br><span class="line">			constructorToUse = (Constructor&lt;?&gt;) mbd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">			if (constructorToUse != null &amp;&amp; mbd.constructorArgumentsResolved) &#123;</span><br><span class="line">				// Found a cached constructor...</span><br><span class="line">				argsToUse = mbd.resolvedConstructorArguments;</span><br><span class="line">				if (argsToUse == null) &#123;</span><br><span class="line">					argsToResolve = mbd.preparedConstructorArguments;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		if (argsToResolve != null) &#123;</span><br><span class="line">			argsToUse = resolvePreparedArguments(beanName, mbd, bw, constructorToUse, argsToResolve, true);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (constructorToUse == null || argsToUse == null) &#123;</span><br><span class="line">		// Take specified constructors, if any.</span><br><span class="line">		Constructor&lt;?&gt;[] candidates = chosenCtors;</span><br><span class="line">		if (candidates == null) &#123;</span><br><span class="line">			Class&lt;?&gt; beanClass = mbd.getBeanClass();</span><br><span class="line">			try &#123;</span><br><span class="line">				candidates = (mbd.isNonPublicAccessAllowed() ?</span><br><span class="line">						beanClass.getDeclaredConstructors() : beanClass.getConstructors());</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Throwable ex) &#123;</span><br><span class="line">				throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">						&quot;Resolution of declared constructors on bean Class [&quot; + beanClass.getName() +</span><br><span class="line">						&quot;] from ClassLoader [&quot; + beanClass.getClassLoader() + &quot;] failed&quot;, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (candidates.length == 1 &amp;&amp; explicitArgs == null &amp;&amp; !mbd.hasConstructorArgumentValues()) &#123;</span><br><span class="line">			Constructor&lt;?&gt; uniqueCandidate = candidates[0];</span><br><span class="line">			if (uniqueCandidate.getParameterCount() == 0) &#123;</span><br><span class="line">				synchronized (mbd.constructorArgumentLock) &#123;</span><br><span class="line">					mbd.resolvedConstructorOrFactoryMethod = uniqueCandidate;</span><br><span class="line">					mbd.constructorArgumentsResolved = true;</span><br><span class="line">					mbd.resolvedConstructorArguments = EMPTY_ARGS;</span><br><span class="line">				&#125;</span><br><span class="line">				bw.setBeanInstance(instantiate(beanName, mbd, uniqueCandidate, EMPTY_ARGS));</span><br><span class="line">				return bw;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Need to resolve the constructor.</span><br><span class="line">		boolean autowiring = (chosenCtors != null ||</span><br><span class="line">				mbd.getResolvedAutowireMode() == AutowireCapableBeanFactory.AUTOWIRE_CONSTRUCTOR);</span><br><span class="line">		ConstructorArgumentValues resolvedValues = null;</span><br><span class="line"></span><br><span class="line">		int minNrOfArgs;</span><br><span class="line">		if (explicitArgs != null) &#123;</span><br><span class="line">			minNrOfArgs = explicitArgs.length;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues();</span><br><span class="line">			resolvedValues = new ConstructorArgumentValues();</span><br><span class="line">			minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		AutowireUtils.sortConstructors(candidates);</span><br><span class="line">		int minTypeDiffWeight = Integer.MAX_VALUE;</span><br><span class="line">		Set&lt;Constructor&lt;?&gt;&gt; ambiguousConstructors = null;</span><br><span class="line">		LinkedList&lt;UnsatisfiedDependencyException&gt; causes = null;</span><br><span class="line"></span><br><span class="line">		for (Constructor&lt;?&gt; candidate : candidates) &#123;</span><br><span class="line">			Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes();</span><br><span class="line"></span><br><span class="line">			if (constructorToUse != null &amp;&amp; argsToUse != null &amp;&amp; argsToUse.length &gt; paramTypes.length) &#123;</span><br><span class="line">				// Already found greedy constructor that can be satisfied -&gt;</span><br><span class="line">				// do not look any further, there are only less greedy constructors left.</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">			if (paramTypes.length &lt; minNrOfArgs) &#123;</span><br><span class="line">				continue;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			ArgumentsHolder argsHolder;</span><br><span class="line">			if (resolvedValues != null) &#123;</span><br><span class="line">				try &#123;</span><br><span class="line">					String[] paramNames = ConstructorPropertiesChecker.evaluate(candidate, paramTypes.length);</span><br><span class="line">					if (paramNames == null) &#123;</span><br><span class="line">						ParameterNameDiscoverer pnd = this.beanFactory.getParameterNameDiscoverer();</span><br><span class="line">						if (pnd != null) &#123;</span><br><span class="line">							paramNames = pnd.getParameterNames(candidate);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					argsHolder = createArgumentArray(beanName, mbd, resolvedValues, bw, paramTypes, paramNames,</span><br><span class="line">							getUserDeclaredConstructor(candidate), autowiring, candidates.length == 1);</span><br><span class="line">				&#125;</span><br><span class="line">				catch (UnsatisfiedDependencyException ex) &#123;</span><br><span class="line">					if (logger.isTraceEnabled()) &#123;</span><br><span class="line">						logger.trace(&quot;Ignoring constructor [&quot; + candidate + &quot;] of bean &apos;&quot; + beanName + &quot;&apos;: &quot; + ex);</span><br><span class="line">					&#125;</span><br><span class="line">					// Swallow and try next constructor.</span><br><span class="line">					if (causes == null) &#123;</span><br><span class="line">						causes = new LinkedList&lt;&gt;();</span><br><span class="line">					&#125;</span><br><span class="line">					causes.add(ex);</span><br><span class="line">					continue;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				// Explicit arguments given -&gt; arguments length must match exactly.</span><br><span class="line">				if (paramTypes.length != explicitArgs.length) &#123;</span><br><span class="line">					continue;</span><br><span class="line">				&#125;</span><br><span class="line">				argsHolder = new ArgumentsHolder(explicitArgs);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			int typeDiffWeight = (mbd.isLenientConstructorResolution() ?</span><br><span class="line">					argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes));</span><br><span class="line">			// Choose this constructor if it represents the closest match.</span><br><span class="line">			if (typeDiffWeight &lt; minTypeDiffWeight) &#123;</span><br><span class="line">				constructorToUse = candidate;</span><br><span class="line">				argsHolderToUse = argsHolder;</span><br><span class="line">				argsToUse = argsHolder.arguments;</span><br><span class="line">				minTypeDiffWeight = typeDiffWeight;</span><br><span class="line">				ambiguousConstructors = null;</span><br><span class="line">			&#125;</span><br><span class="line">			else if (constructorToUse != null &amp;&amp; typeDiffWeight == minTypeDiffWeight) &#123;</span><br><span class="line">				if (ambiguousConstructors == null) &#123;</span><br><span class="line">					ambiguousConstructors = new LinkedHashSet&lt;&gt;();</span><br><span class="line">					ambiguousConstructors.add(constructorToUse);</span><br><span class="line">				&#125;</span><br><span class="line">				ambiguousConstructors.add(candidate);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (constructorToUse == null) &#123;</span><br><span class="line">			if (causes != null) &#123;</span><br><span class="line">				UnsatisfiedDependencyException ex = causes.removeLast();</span><br><span class="line">				for (Exception cause : causes) &#123;</span><br><span class="line">					this.beanFactory.onSuppressedException(cause);</span><br><span class="line">				&#125;</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">			throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">					&quot;Could not resolve matching constructor &quot; +</span><br><span class="line">					&quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		else if (ambiguousConstructors != null &amp;&amp; !mbd.isLenientConstructorResolution()) &#123;</span><br><span class="line">			throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">					&quot;Ambiguous constructor matches found in bean &apos;&quot; + beanName + &quot;&apos; &quot; +</span><br><span class="line">					&quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &quot; +</span><br><span class="line">					ambiguousConstructors);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (explicitArgs == null &amp;&amp; argsHolderToUse != null) &#123;</span><br><span class="line">			argsHolderToUse.storeCache(mbd, constructorToUse);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Assert.state(argsToUse != null, &quot;Unresolved constructor arguments&quot;);</span><br><span class="line">	bw.setBeanInstance(instantiate(beanName, mbd, constructorToUse, argsToUse));</span><br><span class="line">	return bw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其上大量逻辑今天先不研究。</p>
<p>主要是最后两行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bw.setBeanInstance(instantiate(beanName, mbd, constructorToUse, argsToUse));</span><br><span class="line">return bw;</span><br></pre></td></tr></table></figure>

<p>在返回的BeanWapper实例当中，设置了调用instantiate方法返回的实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> // ConstructorResolver类</span><br><span class="line">private Object instantiate(</span><br><span class="line">		String beanName, RootBeanDefinition mbd, Constructor&lt;?&gt; constructorToUse, Object[] argsToUse) &#123;</span><br><span class="line"></span><br><span class="line">	try &#123;</span><br><span class="line">		InstantiationStrategy strategy = this.beanFactory.getInstantiationStrategy();</span><br><span class="line">		if (System.getSecurityManager() != null) &#123;</span><br><span class="line">			return AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt;</span><br><span class="line">					strategy.instantiate(mbd, beanName, this.beanFactory, constructorToUse, argsToUse),</span><br><span class="line">					this.beanFactory.getAccessControlContext());</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			return strategy.instantiate(mbd, beanName, this.beanFactory, constructorToUse, argsToUse);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">				&quot;Bean instantiation via constructor failed&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上instantiate方法的定义，是利用了InstantiationStrategy类型的变量strategy调用instantiate方法根据mbd，beanName，构造函数和参数实例化返回实例结果的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> // 实现InstantiationStrategy接口的类SimpleInstactiationStrategy</span><br><span class="line">@Override</span><br><span class="line">public Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner,</span><br><span class="line">		final Constructor&lt;?&gt; ctor, Object... args) &#123;</span><br><span class="line"></span><br><span class="line">	if (!bd.hasMethodOverrides()) &#123;</span><br><span class="line">		if (System.getSecurityManager() != null) &#123;</span><br><span class="line">			// use own privileged to change accessibility (when security is on)</span><br><span class="line">			AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">				ReflectionUtils.makeAccessible(ctor);</span><br><span class="line">				return null;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		return BeanUtils.instantiateClass(ctor, args);</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		return instantiateWithMethodInjection(bd, beanName, owner, ctor, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上代码可以看出，有BeanUtils下的实例化方法instantiateClass和instantiateWithMethodInjection方法执行实例化。</p>
<p>instantiateClass方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> // BeanUtils类</span><br><span class="line">public static &lt;T&gt; T instantiateClass(Constructor&lt;T&gt; ctor, Object... args) throws BeanInstantiationException &#123;</span><br><span class="line">	Assert.notNull(ctor, &quot;Constructor must not be null&quot;);</span><br><span class="line">	try &#123;</span><br><span class="line">		ReflectionUtils.makeAccessible(ctor);</span><br><span class="line">		if (KotlinDetector.isKotlinReflectPresent() &amp;&amp; KotlinDetector.isKotlinType(ctor.getDeclaringClass())) &#123;</span><br><span class="line">			return KotlinDelegate.instantiateClass(ctor, args);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			Class&lt;?&gt;[] parameterTypes = ctor.getParameterTypes();</span><br><span class="line">			Assert.isTrue(args.length &lt;= parameterTypes.length, &quot;Can&apos;t specify more arguments than constructor parameters&quot;);</span><br><span class="line">			Object[] argsWithDefaultValues = new Object[args.length];</span><br><span class="line">			for (int i = 0 ; i &lt; args.length; i++) &#123;</span><br><span class="line">				if (args[i] == null) &#123;</span><br><span class="line">					Class&lt;?&gt; parameterType = parameterTypes[i];</span><br><span class="line">					argsWithDefaultValues[i] = (parameterType.isPrimitive() ? DEFAULT_TYPE_VALUES.get(parameterType) : null);</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					argsWithDefaultValues[i] = args[i];</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			return ctor.newInstance(argsWithDefaultValues);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	catch (InstantiationException ex) &#123;</span><br><span class="line">		throw new BeanInstantiationException(ctor, &quot;Is it an abstract class?&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (IllegalAccessException ex) &#123;</span><br><span class="line">		throw new BeanInstantiationException(ctor, &quot;Is the constructor accessible?&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (IllegalArgumentException ex) &#123;</span><br><span class="line">		throw new BeanInstantiationException(ctor, &quot;Illegal arguments for constructor&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (InvocationTargetException ex) &#123;</span><br><span class="line">		throw new BeanInstantiationException(ctor, &quot;Constructor threw exception&quot;, ex.getTargetException());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>instantiateWithMethodInjection方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> // 继承自SimpleInstantiationStrategy类的CglibSubclassInstiationStrategy类</span><br><span class="line">@Override</span><br><span class="line">protected Object instantiateWithMethodInjection(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner,</span><br><span class="line">		@Nullable Constructor&lt;?&gt; ctor, Object... args) &#123;</span><br><span class="line"></span><br><span class="line">	// Must generate CGLIB subclass...</span><br><span class="line">	return new CglibSubclassCreator(bd, owner).instantiate(ctor, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上面的实例化代码可知，BeanUtils类的静态方法根据构造函数和参数便可生成实例化结果。而instantiateWithMethodInjection则把实例化的任务委托给了Cglib的instantiate方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// CglibSubclassCreator类</span><br><span class="line">public Object instantiate(@Nullable Constructor&lt;?&gt; ctor, Object... args) &#123;</span><br><span class="line">  Class&lt;?&gt; subclass = createEnhancedSubclass(this.beanDefinition);</span><br><span class="line">  Object instance;</span><br><span class="line">  if (ctor == null) &#123;</span><br><span class="line">    instance = BeanUtils.instantiateClass(subclass);</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      Constructor&lt;?&gt; enhancedSubclassConstructor = subclass.getConstructor(ctor.getParameterTypes());</span><br><span class="line">      instance = enhancedSubclassConstructor.newInstance(args);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">      throw new BeanInstantiationException(this.beanDefinition.getBeanClass(),</span><br><span class="line">          &quot;Failed to invoke constructor for CGLIB enhanced subclass [&quot; + subclass.getName() + &quot;]&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  // SPR-10785: set callbacks directly on the instance instead of in the</span><br><span class="line">  // enhanced class (via the Enhancer) in order to avoid memory leaks.</span><br><span class="line">  Factory factory = (Factory) instance;</span><br><span class="line">  factory.setCallbacks(new Callback[] &#123;NoOp.INSTANCE,</span><br><span class="line">      new LookupOverrideMethodInterceptor(this.beanDefinition, this.owner),</span><br><span class="line">      new ReplaceOverrideMethodInterceptor(this.beanDefinition, this.owner)&#125;);</span><br><span class="line">  return instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体的实例化细节我就不讨论了。</p>
<h4 id="部分2"><a href="#部分2" class="headerlink" title="部分2"></a>部分2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// Initialize the bean instance.</span><br><span class="line">Object exposedObject = bean;</span><br><span class="line">try &#123;</span><br><span class="line">  populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">  exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">&#125;</span><br><span class="line">catch (Throwable ex) &#123;</span><br><span class="line">  if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">    throw (BeanCreationException) ex;</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    throw new BeanCreationException(</span><br><span class="line">        mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此部分重要的是调用了populateBean这个方法，将在之后讨论。最后生成的exposeObject作为返回值返回。</p>
<h5 id="populateBean"><a href="#populateBean" class="headerlink" title="populateBean"></a>populateBean</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;deprecation&quot;)  // for postProcessPropertyValues</span><br><span class="line">protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) &#123;</span><br><span class="line">	if (bw == null) &#123;</span><br><span class="line">		if (mbd.hasPropertyValues()) &#123;</span><br><span class="line">			throw new BeanCreationException(</span><br><span class="line">					mbd.getResourceDescription(), beanName, &quot;Cannot apply property values to null instance&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			// Skip property population phase for null instance.</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span><br><span class="line">	// state of the bean before properties are set. This can be used, for example,</span><br><span class="line">	// to support styles of field injection.</span><br><span class="line">	boolean continueWithPropertyPopulation = true;</span><br><span class="line"></span><br><span class="line">	if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">		for (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">			if (bp instanceof InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">				InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">				if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">					continueWithPropertyPopulation = false;</span><br><span class="line">					break;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (!continueWithPropertyPopulation) &#123;</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null);</span><br><span class="line"></span><br><span class="line">	int resolvedAutowireMode = mbd.getResolvedAutowireMode();</span><br><span class="line">	if (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">		MutablePropertyValues newPvs = new MutablePropertyValues(pvs);</span><br><span class="line">		// Add property values based on autowire by name if applicable.</span><br><span class="line">		if (resolvedAutowireMode == AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">			autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">		&#125;</span><br><span class="line">		// Add property values based on autowire by type if applicable.</span><br><span class="line">		if (resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">			autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">		&#125;</span><br><span class="line">		pvs = newPvs;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">	boolean needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line"></span><br><span class="line">	PropertyDescriptor[] filteredPds = null;</span><br><span class="line">	if (hasInstAwareBpps) &#123;</span><br><span class="line">		if (pvs == null) &#123;</span><br><span class="line">			pvs = mbd.getPropertyValues();</span><br><span class="line">		&#125;</span><br><span class="line">		for (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">			if (bp instanceof InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">				InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">				PropertyValues pvsToUse = ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);</span><br><span class="line">				if (pvsToUse == null) &#123;</span><br><span class="line">					if (filteredPds == null) &#123;</span><br><span class="line">						filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">					&#125;</span><br><span class="line">					pvsToUse = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">					if (pvsToUse == null) &#123;</span><br><span class="line">						return;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				pvs = pvsToUse;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if (needsDepCheck) &#123;</span><br><span class="line">		if (filteredPds == null) &#123;</span><br><span class="line">			filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">		&#125;</span><br><span class="line">		checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (pvs != null) &#123;</span><br><span class="line">		applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上大量逻辑我还是只讲最后重要的几行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (pvs != null) &#123;</span><br><span class="line">  applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上当pvs，也就是属性值集不为空时，会调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractAutowireCapableBeanFactory类</span><br><span class="line">protected void applyPropertyValues(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs) &#123;</span><br><span class="line">	if (pvs.isEmpty()) &#123;</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (System.getSecurityManager() != null &amp;&amp; bw instanceof BeanWrapperImpl) &#123;</span><br><span class="line">		((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MutablePropertyValues mpvs = null;</span><br><span class="line">	List&lt;PropertyValue&gt; original;</span><br><span class="line"></span><br><span class="line">	if (pvs instanceof MutablePropertyValues) &#123;</span><br><span class="line">		mpvs = (MutablePropertyValues) pvs;</span><br><span class="line">		if (mpvs.isConverted()) &#123;</span><br><span class="line">			// Shortcut: use the pre-converted values as-is.</span><br><span class="line">			try &#123;</span><br><span class="line">				bw.setPropertyValues(mpvs);</span><br><span class="line">				return;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (BeansException ex) &#123;</span><br><span class="line">				throw new BeanCreationException(</span><br><span class="line">						mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		original = mpvs.getPropertyValueList();</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		original = Arrays.asList(pvs.getPropertyValues());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TypeConverter converter = getCustomTypeConverter();</span><br><span class="line">	if (converter == null) &#123;</span><br><span class="line">		converter = bw;</span><br><span class="line">	&#125;</span><br><span class="line">	BeanDefinitionValueResolver valueResolver = new BeanDefinitionValueResolver(this, beanName, mbd, converter);</span><br><span class="line"></span><br><span class="line">	// Create a deep copy, resolving any references for values.</span><br><span class="line">	List&lt;PropertyValue&gt; deepCopy = new ArrayList&lt;&gt;(original.size());</span><br><span class="line">	boolean resolveNecessary = false;</span><br><span class="line">	for (PropertyValue pv : original) &#123;</span><br><span class="line">		if (pv.isConverted()) &#123;</span><br><span class="line">			deepCopy.add(pv);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			String propertyName = pv.getName();</span><br><span class="line">			Object originalValue = pv.getValue();</span><br><span class="line">			if (originalValue == AutowiredPropertyMarker.INSTANCE) &#123;</span><br><span class="line">				Method writeMethod = bw.getPropertyDescriptor(propertyName).getWriteMethod();</span><br><span class="line">				if (writeMethod == null) &#123;</span><br><span class="line">					throw new IllegalArgumentException(&quot;Autowire marker for property without write method: &quot; + pv);</span><br><span class="line">				&#125;</span><br><span class="line">				originalValue = new DependencyDescriptor(new MethodParameter(writeMethod, 0), true);</span><br><span class="line">			&#125;</span><br><span class="line">			Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue);</span><br><span class="line">			Object convertedValue = resolvedValue;</span><br><span class="line">			boolean convertible = bw.isWritableProperty(propertyName) &amp;&amp;</span><br><span class="line">					!PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName);</span><br><span class="line">			if (convertible) &#123;</span><br><span class="line">				convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter);</span><br><span class="line">			&#125;</span><br><span class="line">			// Possibly store converted value in merged bean definition,</span><br><span class="line">			// in order to avoid re-conversion for every created bean instance.</span><br><span class="line">			if (resolvedValue == originalValue) &#123;</span><br><span class="line">				if (convertible) &#123;</span><br><span class="line">					pv.setConvertedValue(convertedValue);</span><br><span class="line">				&#125;</span><br><span class="line">				deepCopy.add(pv);</span><br><span class="line">			&#125;</span><br><span class="line">			else if (convertible &amp;&amp; originalValue instanceof TypedStringValue &amp;&amp;</span><br><span class="line">					!((TypedStringValue) originalValue).isDynamic() &amp;&amp;</span><br><span class="line">					!(convertedValue instanceof Collection || ObjectUtils.isArray(convertedValue))) &#123;</span><br><span class="line">				pv.setConvertedValue(convertedValue);</span><br><span class="line">				deepCopy.add(pv);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				resolveNecessary = true;</span><br><span class="line">				deepCopy.add(new PropertyValue(pv, convertedValue));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if (mpvs != null &amp;&amp; !resolveNecessary) &#123;</span><br><span class="line">		mpvs.setConverted();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Set our (possibly massaged) deep copy.</span><br><span class="line">	try &#123;</span><br><span class="line">		bw.setPropertyValues(new MutablePropertyValues(deepCopy));</span><br><span class="line">	&#125;</span><br><span class="line">	catch (BeansException ex) &#123;</span><br><span class="line">		throw new BeanCreationException(</span><br><span class="line">				mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，applyPropertyValues方法会利用传进来的pvs变量，对其中每一个property知调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">BeanDefinitionValueResolver valueResolver = new BeanDefinitionValueResolver(this, beanName, mbd, converter);</span><br><span class="line"></span><br><span class="line">Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue);</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>从以上代码，可知解析属性值调用了BeanDefinitionValueResolver类型方法resolveIfNecessary方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"> // BeanDefinitionValueResolver类</span><br><span class="line">@Nullable</span><br><span class="line">public Object resolveValueIfNecessary(Object argName, @Nullable Object value) &#123;</span><br><span class="line">	// We must check each value to see whether it requires a runtime reference</span><br><span class="line">	// to another bean to be resolved.</span><br><span class="line">	if (value instanceof RuntimeBeanReference) &#123;</span><br><span class="line">		RuntimeBeanReference ref = (RuntimeBeanReference) value;</span><br><span class="line">		return resolveReference(argName, ref);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof RuntimeBeanNameReference) &#123;</span><br><span class="line">		String refName = ((RuntimeBeanNameReference) value).getBeanName();</span><br><span class="line">		refName = String.valueOf(doEvaluate(refName));</span><br><span class="line">		if (!this.beanFactory.containsBean(refName)) &#123;</span><br><span class="line">			throw new BeanDefinitionStoreException(</span><br><span class="line">					&quot;Invalid bean name &apos;&quot; + refName + &quot;&apos; in bean reference for &quot; + argName);</span><br><span class="line">		&#125;</span><br><span class="line">		return refName;</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof BeanDefinitionHolder) &#123;</span><br><span class="line">		// Resolve BeanDefinitionHolder: contains BeanDefinition with name and aliases.</span><br><span class="line">		BeanDefinitionHolder bdHolder = (BeanDefinitionHolder) value;</span><br><span class="line">		return resolveInnerBean(argName, bdHolder.getBeanName(), bdHolder.getBeanDefinition());</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof BeanDefinition) &#123;</span><br><span class="line">		// Resolve plain BeanDefinition, without contained name: use dummy name.</span><br><span class="line">		BeanDefinition bd = (BeanDefinition) value;</span><br><span class="line">		String innerBeanName = &quot;(inner bean)&quot; + BeanFactoryUtils.GENERATED_BEAN_NAME_SEPARATOR +</span><br><span class="line">				ObjectUtils.getIdentityHexString(bd);</span><br><span class="line">		return resolveInnerBean(argName, innerBeanName, bd);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof DependencyDescriptor) &#123;</span><br><span class="line">		Set&lt;String&gt; autowiredBeanNames = new LinkedHashSet&lt;&gt;(4);</span><br><span class="line">		Object result = this.beanFactory.resolveDependency(</span><br><span class="line">				(DependencyDescriptor) value, this.beanName, autowiredBeanNames, this.typeConverter);</span><br><span class="line">		for (String autowiredBeanName : autowiredBeanNames) &#123;</span><br><span class="line">			if (this.beanFactory.containsBean(autowiredBeanName)) &#123;</span><br><span class="line">				this.beanFactory.registerDependentBean(autowiredBeanName, this.beanName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof ManagedArray) &#123;</span><br><span class="line">		// May need to resolve contained runtime references.</span><br><span class="line">		ManagedArray array = (ManagedArray) value;</span><br><span class="line">		Class&lt;?&gt; elementType = array.resolvedElementType;</span><br><span class="line">		if (elementType == null) &#123;</span><br><span class="line">			String elementTypeName = array.getElementTypeName();</span><br><span class="line">			if (StringUtils.hasText(elementTypeName)) &#123;</span><br><span class="line">				try &#123;</span><br><span class="line">					elementType = ClassUtils.forName(elementTypeName, this.beanFactory.getBeanClassLoader());</span><br><span class="line">					array.resolvedElementType = elementType;</span><br><span class="line">				&#125;</span><br><span class="line">				catch (Throwable ex) &#123;</span><br><span class="line">					// Improve the message by showing the context.</span><br><span class="line">					throw new BeanCreationException(</span><br><span class="line">							this.beanDefinition.getResourceDescription(), this.beanName,</span><br><span class="line">							&quot;Error resolving array type for &quot; + argName, ex);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				elementType = Object.class;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return resolveManagedArray(argName, (List&lt;?&gt;) value, elementType);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof ManagedList) &#123;</span><br><span class="line">		// May need to resolve contained runtime references.</span><br><span class="line">		return resolveManagedList(argName, (List&lt;?&gt;) value);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof ManagedSet) &#123;</span><br><span class="line">		// May need to resolve contained runtime references.</span><br><span class="line">		return resolveManagedSet(argName, (Set&lt;?&gt;) value);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof ManagedMap) &#123;</span><br><span class="line">		// May need to resolve contained runtime references.</span><br><span class="line">		return resolveManagedMap(argName, (Map&lt;?, ?&gt;) value);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof ManagedProperties) &#123;</span><br><span class="line">		Properties original = (Properties) value;</span><br><span class="line">		Properties copy = new Properties();</span><br><span class="line">		original.forEach((propKey, propValue) -&gt; &#123;</span><br><span class="line">			if (propKey instanceof TypedStringValue) &#123;</span><br><span class="line">				propKey = evaluate((TypedStringValue) propKey);</span><br><span class="line">			&#125;</span><br><span class="line">			if (propValue instanceof TypedStringValue) &#123;</span><br><span class="line">				propValue = evaluate((TypedStringValue) propValue);</span><br><span class="line">			&#125;</span><br><span class="line">			if (propKey == null || propValue == null) &#123;</span><br><span class="line">				throw new BeanCreationException(</span><br><span class="line">						this.beanDefinition.getResourceDescription(), this.beanName,</span><br><span class="line">						&quot;Error converting Properties key/value pair for &quot; + argName + &quot;: resolved to null&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			copy.put(propKey, propValue);</span><br><span class="line">		&#125;);</span><br><span class="line">		return copy;</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof TypedStringValue) &#123;</span><br><span class="line">		// Convert value to target type here.</span><br><span class="line">		TypedStringValue typedStringValue = (TypedStringValue) value;</span><br><span class="line">		Object valueObject = evaluate(typedStringValue);</span><br><span class="line">		try &#123;</span><br><span class="line">			Class&lt;?&gt; resolvedTargetType = resolveTargetType(typedStringValue);</span><br><span class="line">			if (resolvedTargetType != null) &#123;</span><br><span class="line">				return this.typeConverter.convertIfNecessary(valueObject, resolvedTargetType);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				return valueObject;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (Throwable ex) &#123;</span><br><span class="line">			// Improve the message by showing the context.</span><br><span class="line">			throw new BeanCreationException(</span><br><span class="line">					this.beanDefinition.getResourceDescription(), this.beanName,</span><br><span class="line">					&quot;Error converting typed String value for &quot; + argName, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else if (value instanceof NullBean) &#123;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		return evaluate(value);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Nullable</span><br><span class="line">private Object resolveInnerBean(Object argName, String innerBeanName, BeanDefinition innerBd) &#123;</span><br><span class="line">	RootBeanDefinition mbd = null;</span><br><span class="line">	try &#123;</span><br><span class="line">		mbd = this.beanFactory.getMergedBeanDefinition(innerBeanName, innerBd, this.beanDefinition);</span><br><span class="line">		// Check given bean name whether it is unique. If not already unique,</span><br><span class="line">		// add counter - increasing the counter until the name is unique.</span><br><span class="line">		String actualInnerBeanName = innerBeanName;</span><br><span class="line">		if (mbd.isSingleton()) &#123;</span><br><span class="line">			actualInnerBeanName = adaptInnerBeanName(innerBeanName);</span><br><span class="line">		&#125;</span><br><span class="line">		this.beanFactory.registerContainedBean(actualInnerBeanName, this.beanName);</span><br><span class="line">		// Guarantee initialization of beans that the inner bean depends on.</span><br><span class="line">		String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">		if (dependsOn != null) &#123;</span><br><span class="line">			for (String dependsOnBean : dependsOn) &#123;</span><br><span class="line">				this.beanFactory.registerDependentBean(dependsOnBean, actualInnerBeanName);</span><br><span class="line">				this.beanFactory.getBean(dependsOnBean);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		// Actually create the inner bean instance now...</span><br><span class="line">		Object innerBean = this.beanFactory.createBean(actualInnerBeanName, mbd, null);</span><br><span class="line">		if (innerBean instanceof FactoryBean) &#123;</span><br><span class="line">			boolean synthetic = mbd.isSynthetic();</span><br><span class="line">			innerBean = this.beanFactory.getObjectFromFactoryBean(</span><br><span class="line">					(FactoryBean&lt;?&gt;) innerBean, actualInnerBeanName, !synthetic);</span><br><span class="line">		&#125;</span><br><span class="line">		if (innerBean instanceof NullBean) &#123;</span><br><span class="line">			innerBean = null;</span><br><span class="line">		&#125;</span><br><span class="line">		return innerBean;</span><br><span class="line">	&#125;</span><br><span class="line">	catch (BeansException ex) &#123;</span><br><span class="line">		throw new BeanCreationException(</span><br><span class="line">				this.beanDefinition.getResourceDescription(), this.beanName,</span><br><span class="line">				&quot;Cannot create inner bean &apos;&quot; + innerBeanName + &quot;&apos; &quot; +</span><br><span class="line">				(mbd != null &amp;&amp; mbd.getBeanClassName() != null ? &quot;of type [&quot; + mbd.getBeanClassName() + &quot;] &quot; : &quot;&quot;) +</span><br><span class="line">				&quot;while setting &quot; + argName, ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后会将转化后的pv值加至deepCopy变量中，并赋予BeanWapper类型变量bw中。</p>
<h3 id="getObjectForBeanInstance"><a href="#getObjectForBeanInstance" class="headerlink" title="getObjectForBeanInstance"></a>getObjectForBeanInstance</h3><p>以下是具体的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"> // AbstractBeanFactory类</span><br><span class="line">protected Object getObjectForBeanInstance(</span><br><span class="line">		Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) &#123;</span><br><span class="line"></span><br><span class="line">	// Don&apos;t let calling code try to dereference the factory if the bean isn&apos;t a factory.</span><br><span class="line">	if (BeanFactoryUtils.isFactoryDereference(name)) &#123;</span><br><span class="line">		if (beanInstance instanceof NullBean) &#123;</span><br><span class="line">			return beanInstance;</span><br><span class="line">		&#125;</span><br><span class="line">		if (!(beanInstance instanceof FactoryBean)) &#123;</span><br><span class="line">			throw new BeanIsNotAFactoryException(beanName, beanInstance.getClass());</span><br><span class="line">		&#125;</span><br><span class="line">		if (mbd != null) &#123;</span><br><span class="line">			mbd.isFactoryBean = true;</span><br><span class="line">		&#125;</span><br><span class="line">		return beanInstance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span><br><span class="line">	// If it&apos;s a FactoryBean, we use it to create a bean instance, unless the</span><br><span class="line">	// caller actually wants a reference to the factory.</span><br><span class="line">	if (!(beanInstance instanceof FactoryBean)) &#123;</span><br><span class="line">		return beanInstance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Object object = null;</span><br><span class="line">	if (mbd != null) &#123;</span><br><span class="line">		mbd.isFactoryBean = true;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		object = getCachedObjectForFactoryBean(beanName);</span><br><span class="line">	&#125;</span><br><span class="line">	if (object == null) &#123;</span><br><span class="line">		// Return bean instance from factory.</span><br><span class="line">		FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance;</span><br><span class="line">		// Caches object obtained from FactoryBean if it is a singleton.</span><br><span class="line">		if (mbd == null &amp;&amp; containsBeanDefinition(beanName)) &#123;</span><br><span class="line">			mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">		boolean synthetic = (mbd != null &amp;&amp; mbd.isSynthetic());</span><br><span class="line">		object = getObjectFromFactoryBean(factory, beanName, !synthetic);</span><br><span class="line">	&#125;</span><br><span class="line">	return object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此方法主要是在我们获取bean实例之后，可以分辨是普通的bean还是factoryBean。如果bean不是FactoryBean类型的，则直接返回。否则执行获取将bean实例转化为FactoryBean，并获取实例。逻辑主要在getObjectFromFactoryBean方法中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"> // FactoryBeanRegistrySupport类</span><br><span class="line">protected Object getObjectFromFactoryBean(FactoryBean&lt;?&gt; factory, String beanName, boolean shouldPostProcess) &#123;</span><br><span class="line">	if (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;</span><br><span class="line">		synchronized (getSingletonMutex()) &#123;</span><br><span class="line">			Object object = this.factoryBeanObjectCache.get(beanName);</span><br><span class="line">			if (object == null) &#123;</span><br><span class="line">				object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">				// Only post-process and store if not put there already during getObject() call above</span><br><span class="line">				// (e.g. because of circular reference processing triggered by custom getBean calls)</span><br><span class="line">				Object alreadyThere = this.factoryBeanObjectCache.get(beanName);</span><br><span class="line">				if (alreadyThere != null) &#123;</span><br><span class="line">					object = alreadyThere;</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					if (shouldPostProcess) &#123;</span><br><span class="line">						if (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">							// Temporarily return non-post-processed object, not storing it yet..</span><br><span class="line">							return object;</span><br><span class="line">						&#125;</span><br><span class="line">						beforeSingletonCreation(beanName);</span><br><span class="line">						try &#123;</span><br><span class="line">							object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">						&#125;</span><br><span class="line">						catch (Throwable ex) &#123;</span><br><span class="line">							throw new BeanCreationException(beanName,</span><br><span class="line">									&quot;Post-processing of FactoryBean&apos;s singleton object failed&quot;, ex);</span><br><span class="line">						&#125;</span><br><span class="line">						finally &#123;</span><br><span class="line">							afterSingletonCreation(beanName);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					if (containsSingleton(beanName)) &#123;</span><br><span class="line">						this.factoryBeanObjectCache.put(beanName, object);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			return object;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		Object object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">		if (shouldPostProcess) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Throwable ex) &#123;</span><br><span class="line">				throw new BeanCreationException(beanName, &quot;Post-processing of FactoryBean&apos;s object failed&quot;, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return object;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private Object doGetObjectFromFactoryBean(final FactoryBean&lt;?&gt; factory, final String beanName)</span><br><span class="line">		throws BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">	Object object;</span><br><span class="line">	try &#123;</span><br><span class="line">		if (System.getSecurityManager() != null) &#123;</span><br><span class="line">			AccessControlContext acc = getAccessControlContext();</span><br><span class="line">			try &#123;</span><br><span class="line">				object = AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) factory::getObject, acc);</span><br><span class="line">			&#125;</span><br><span class="line">			catch (PrivilegedActionException pae) &#123;</span><br><span class="line">				throw pae.getException();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			object = factory.getObject();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	catch (FactoryBeanNotInitializedException ex) &#123;</span><br><span class="line">		throw new BeanCurrentlyInCreationException(beanName, ex.toString());</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		throw new BeanCreationException(beanName, &quot;FactoryBean threw exception on object creation&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Do not accept a null value for a FactoryBean that&apos;s not fully</span><br><span class="line">	// initialized yet: Many FactoryBeans just return null then.</span><br><span class="line">	if (object == null) &#123;</span><br><span class="line">		if (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">			throw new BeanCurrentlyInCreationException(</span><br><span class="line">					beanName, &quot;FactoryBean which is currently in creation returned null from getObject&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		object = new NullBean();</span><br><span class="line">	&#125;</span><br><span class="line">	return object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getObjectFromFactoryBean和doGetObjectFromFactoryBean这两个函数的具体逻辑我就不细讲了。主要还是依据FactoryBean实例和beanName生成返回实例对象。</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>最后在简单地讲解完</p>
<ul>
<li>getMergedLocalBeanDefinition</li>
<li>createBean</li>
<li>getObjectForBeanInstance</li>
</ul>
<p>三个方法后，我们回到doGetBean方法。</p>
<p>此方法接受beanName，需要的bean类型和构造参数。最后，我们据此生成了之前便注册在spring的beanFactory容器中的beanDefinition的实例。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上是对ApplicationContext接口变量调用getBean方法生成bean实例的流程。贴了大量代码，解析比较少。以后有时间会继续研究。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/02/spring学习2/" data-id="ck2lejqmk003gm8v5nsjg096v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/11/03/javaweb学习笔记6/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          javaweb之springmvc视图与控制器数据传输
        
      </div>
    </a>
  
  
    <a href="/2019/11/01/spring学习1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">spring初识1</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/web技术/">web技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/哲学/">哲学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/外语学习/">外语学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/持久层技术/">持久层技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构与算法/">数据结构与算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程基础/">编程基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/软件构造思想/">软件构造思想</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/面向对象设计/">面向对象设计</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">时间</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/11/05/java集合框架学习10/">java集合框架-LinkedHashSet与LinkedHashMap</a>
          </li>
        
          <li>
            <a href="/2019/11/05/java集合框架学习9/">java集合框架-ArrayList与LinkedList</a>
          </li>
        
          <li>
            <a href="/2019/11/04/javaweb学习笔记7/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/11/03/javaweb学习笔记6/">javaweb之springmvc视图与控制器数据传输</a>
          </li>
        
          <li>
            <a href="/2019/11/02/spring学习2/">spring初识2</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 feomouse<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
<!--   
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
   -->
  
    <a href="/categories/web技术" class="mobile-nav-link">web技术</a>
  
    <a href="/categories/哲学" class="mobile-nav-link">哲学</a>
  
    <a href="/categories/外语学习" class="mobile-nav-link">外语学习</a>
  
    <a href="/categories/持久层技术" class="mobile-nav-link">持久层技术</a>
  
    <a href="/categories/数据结构与算法" class="mobile-nav-link">数据结构与算法</a>
  
    <a href="/categories/编程基础" class="mobile-nav-link">编程基础</a>
  
    <a href="/categories/软件构造思想" class="mobile-nav-link">软件构造思想</a>
  
    <a href="/categories/面向对象设计" class="mobile-nav-link">面向对象设计</a>
  
</nav>
    

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>